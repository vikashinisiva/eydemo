import { useState } from 'react';
import { motion } from 'framer-motion';
import { 
  X, Brain, FileText, Shield, TrendingUp, Download, Rocket, Clock,
  Activity, Dna, Target, AlertTriangle, BarChart3, LineChart, PieChart,
  Microscope, FlaskConical, Users, Calendar, DollarSign, Award
} from 'lucide-react';
import { 
  RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, 
  LineChart as RechartsLine, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
  BarChart as RechartsBar, Bar, Cell, ResponsiveContainer, PieChart as RechartsPie, Pie
} from 'recharts';

export default function EvidencePanel({ drug, result, onClose }) {
  const [activeTab, setActiveTab] = useState('overview');

  // Prepare data for visualizations
  const scoreData = [
    { subject: 'Mechanism', value: (result.mechanismScore || 0.92) * 100, fullMark: 100 },
    { subject: 'Safety', value: (result.safetyScore || 0.88) * 100, fullMark: 100 },
    { subject: 'Efficacy', value: (result.efficacyScore || 0.79) * 100, fullMark: 100 },
    { subject: 'Commercial', value: result.confidence * 100, fullMark: 100 },
    { subject: 'Evidence', value: (result.evidence.publications / 500) * 100, fullMark: 100 }
  ];

  const adverseEventData = [
    { name: 'Mild', value: result.adverseEvents?.mild || 12, color: '#10b981' },
    { name: 'Moderate', value: result.adverseEvents?.moderate || 3, color: '#f59e0b' },
    { name: 'Severe', value: result.adverseEvents?.severe || 1, color: '#ef4444' }
  ];

  const publications = result.publications || [
    { year: 2020, count: 89, topic: 'Preclinical' },
    { year: 2021, count: 102, topic: 'Epidemiology' },
    { year: 2022, count: 76, topic: 'Mechanism' },
    { year: 2023, count: 78, topic: 'Clinical' }
  ];

  const tabs = [
    { id: 'overview', label: 'Overview', icon: Target },
    { id: 'mechanism', label: 'Mechanism', icon: Dna },
    { id: 'evidence', label: 'Evidence', icon: FileText },
    { id: 'clinical', label: 'Clinical Data', icon: Activity },
    { id: 'safety', label: 'Safety Profile', icon: Shield },
    { id: 'commercial', label: 'Commercial', icon: DollarSign }
  ];

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 overflow-y-auto"
      onClick={onClose}
    >
      <motion.div
        initial={{ scale: 0.95, y: 20 }}
        animate={{ scale: 1, y: 0 }}
        exit={{ scale: 0.95, y: 20 }}
        onClick={(e) => e.stopPropagation()}
        className="glass-card max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col"
      >
        {/* Header */}
        <div className="sticky top-0 bg-white/95 backdrop-blur-lg border-b border-gray-200 p-6 z-10">
          <div className="flex items-start justify-between">
            <div>
              <h2 className="text-3xl font-bold text-gray-800 mb-2">
                {result.disease}
              </h2>
              <p className="text-gray-600">
                Step 3: Deep Dive Evidence & Reasoning for {drug}
              </p>
            </div>
            <motion.button
              whileHover={{ scale: 1.1, rotate: 90 }}
              whileTap={{ scale: 0.9 }}
              onClick={onClose}
              className="p-2 hover:bg-gray-100 rounded-full transition-colors"
            >
              <X className="w-6 h-6" />
            </motion.button>
          </div>

          {/* Confidence Badge */}
          <div className="mt-4">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${result.confidence * 100}%` }}
              transition={{ duration: 1, ease: "easeOut" }}
              className={`h-3 rounded-full ${
                result.confidence > 0.8
                  ? 'bg-gradient-to-r from-green-500 to-green-600'
                  : 'bg-gradient-to-r from-blue-500 to-blue-600'
              }`}
            />
            <div className="flex justify-between mt-2">
              <span className="text-sm font-semibold text-gray-600">
                Confidence Score
              </span>
              <span className={`text-sm font-bold ${
                result.confidence > 0.8 ? 'text-green-600' : 'text-blue-600'
              }`}>
                {(result.confidence * 100).toFixed(0)}% {result.confidence > 0.8 ? '(HIGH)' : '(MEDIUM)'}
              </span>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 space-y-6">
          {/* Rationale */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            className="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-xl border-2 border-blue-200"
          >
            <div className="flex items-center gap-3 mb-4">
              <Brain className="w-6 h-6 text-blue-600" />
              <h3 className="text-xl font-bold text-gray-800">Why This Makes Scientific Sense</h3>
            </div>
            <p className="text-gray-700 leading-relaxed text-lg">{result.rationale}</p>
          </motion.div>

          {/* Mechanism */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="grid md:grid-cols-2 gap-6"
          >
            <div className="bg-orange-50 p-6 rounded-xl border border-orange-200">
              <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <span className="text-orange-600">ðŸ”¬</span> Drug Side Effect
              </h4>
              <div className="text-2xl font-bold text-orange-900">{result.drivingEffect}</div>
            </div>

            <div className="bg-green-50 p-6 rounded-xl border border-green-200">
              <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <span className="text-green-600">âœ“</span> Therapeutic Benefit
              </h4>
              <div className="text-lg font-semibold text-green-900">{result.mechanism}</div>
            </div>
          </motion.div>

          {/* Evidence Breakdown */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className="bg-white p-6 rounded-xl border-2 border-gray-200"
          >
            <div className="flex items-center gap-3 mb-4">
              <FileText className="w-6 h-6 text-purple-600" />
              <h3 className="text-xl font-bold text-gray-800">Scientific Evidence Base</h3>
            </div>

            <div className="grid md:grid-cols-3 gap-4">
              <div className="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div className="text-3xl font-bold text-blue-600 mb-1">
                  {result.evidence.publications}
                </div>
                <div className="text-sm font-semibold text-gray-600">Publications</div>
                <div className="text-xs text-gray-500 mt-1">PubMed Citations</div>
              </div>

              <div className="text-center p-4 bg-green-50 rounded-lg border border-green-200">
                <div className="text-3xl font-bold text-green-600 mb-1">
                  {result.evidence.trials}
                </div>
                <div className="text-sm font-semibold text-gray-600">Clinical Trials</div>
                <div className="text-xs text-gray-500 mt-1">Active Studies</div>
              </div>

              <div className="text-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                <div className="text-lg font-bold text-purple-600 mb-1">
                  {result.evidence.phase}
                </div>
                <div className="text-sm font-semibold text-gray-600">Current Phase</div>
                <div className="text-xs text-gray-500 mt-1">Development Stage</div>
              </div>
            </div>
          </motion.div>

          {/* Patent & Commercial */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4 }}
            className="grid md:grid-cols-2 gap-6"
          >
            <div className="bg-yellow-50 p-6 rounded-xl border border-yellow-200">
              <div className="flex items-center gap-3 mb-3">
                <Shield className="w-5 h-5 text-yellow-600" />
                <h4 className="font-bold text-gray-800">Patent Status</h4>
              </div>
              <div className="text-lg font-semibold text-yellow-900 mb-2">
                {result.patentStatus}
              </div>
              <div className="flex items-center gap-2 text-sm">
                <span className={`px-3 py-1 rounded-full font-medium ${
                  result.patentStatus.includes('Expired')
                    ? 'bg-green-100 text-green-700'
                    : 'bg-yellow-100 text-yellow-700'
                }`}>
                  {result.patentStatus.includes('Expired') ? 'âœ“ No Barriers' : 'âš  Some Restrictions'}
                </span>
              </div>
            </div>

            <div className="bg-purple-50 p-6 rounded-xl border border-purple-200">
              <div className="flex items-center gap-3 mb-3">
                <TrendingUp className="w-5 h-5 text-purple-600" />
                <h4 className="font-bold text-gray-800">Commercial Viability</h4>
              </div>
              <div className="text-lg font-semibold text-purple-900 mb-2">
                {result.commercialViability}
              </div>
              <div className="flex items-center gap-2 text-sm">
                <Clock className="w-4 h-4 text-purple-600" />
                <span className="text-gray-700">Time to Market: {result.timeToMarket}</span>
              </div>
            </div>
          </motion.div>

          {/* Actions */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.5 }}
            className="grid md:grid-cols-3 gap-4 pt-4 border-t border-gray-200"
          >
            <motion.button
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className="btn-primary flex items-center justify-center gap-2"
            >
              <Download className="w-5 h-5" />
              PDF Report
            </motion.button>

            <motion.button
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className="btn-secondary flex items-center justify-center gap-2"
            >
              <FileText className="w-5 h-5" />
              Export Data
            </motion.button>

            <motion.button
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              onClick={() => {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYHGmm98OScTgwOUKjo77hdGwU7k9nyyXkrBSh+zPLaizsIGGS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBSh7yvHajzwJGWS56+mjUBELTKXh8bllHAU2jdTxz3wvBQ==');
                audio.play();
                alert('ðŸš€ Added to R&D Pipeline!\n\n' + 
                      `${drug} for ${result.disease}\n` +
                      `Confidence: ${(result.confidence * 100).toFixed(0)}%\n\n` +
                      'Next steps: Preclinical validation â†’ IND filing â†’ Clinical trials');
              }}
              className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2"
            >
              <Rocket className="w-5 h-5" />
              Launch Program
            </motion.button>
          </motion.div>
        </div>
      </motion.div>
    </motion.div>
  );
}
